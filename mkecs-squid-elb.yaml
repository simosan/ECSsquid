AWSTemplateFormatVersion: '2010-09-09'

Parameters:
 ProjectName:
   Type: String
   Default: 'MKECS-SIM-SQUID-ELB'
 AppName:
   Type: String
   Default: 'simsquid'
 RepositoryName:
   Type: String
   Default: 'Image name (excluding account)'
 VpcId:
   Type: String
   Default: 'VPC ID'
 ProtectedSubnets1:
   Type: String
   Default: 'Specify the ID of the private subnet where the router to the public subnet with the NAT gateway is located.'
 ProtectedSubnets2:
   Type: String
   Default: 'Specify the ID of the private subnet where the router to the public subnet with the NAT gateway is located.'
 OutboundIpRange:
   Type: String
   Default: '0.0.0.0/0'
   # Set up appropriately. In this case, all communication is allowed.
 InboundIpRange:
   Type: String
   Default: '0.0.0.0/0'
   # Set up appropriately. In this case, all communication is allowed.
 ContainerPort:
   Type: Number
   Default: 8080
   # ECS task listening port
 ListenerPort:
   Type: Number
   Default: 8080
   # NLB listening port
 TargetType:
   Type: String
   Default: "ip"
 Hostedzonename:
   Type: String
   Default: "simosan-proxy.com."
   # Hostzone name for Route53 
 AliasName:
   Type: String
   Default: "simsquid.simosan-proxy.com."
   # Alias name that attaches the NLB host name to the Route53 hostzone
 HealthCheckGracePeriodSecond:
   Type: String
   Default: "100"
 TaskCpu:
   Type: Number
   Default: 256
 TaskMemory:
   Type: Number
   Default: 512
 DesiredCount:
   Type: Number
   Default: 2
   # Always run two units with MultiAZ
 EFSFileSystemId:
   Type: String
   Default: 'EFS file system ID'
 EFSFileSystemNameConf:
   Type: String
   Default: 'sim-squid-efs-conf' 
 EFSHostRootShareConf:
   Type: String
   Default: '/simsquid/elb/conf'
 EFSAccesspointConf:
   Type: String
   Default: 'Access point ID'
 EFSFileSystemNameCache:
   Type: String
   Default: 'sim-squid-efs-cache'
 EFSHostRootShareCache:
   Type: String
   Default: '/simsquid/elb/cache'
 EFSAccesspointCache:
   Type: String
   Default: 'Access point ID'
 EFSFileSystemNameLog:
   Type: String
   Default: 'sim-squid-efs-log'
 EFSHostRootShareLog:
   Type: String
   Default: '/simsquid/elb/log'
 EFSAccesspointLog:
   Type: String
   Default: 'Access point ID'
 
# -------------------------------------
# Fargateの通信を許可するセキュリティグループ
# -------------------------------------
Resources:
  SecurityGroup:
   Type: AWS::EC2::SecurityGroup
   Properties:
     Tags:
       - Key: Name
         Value: !Ref ProjectName
     GroupName: !Ref ProjectName
     GroupDescription: Security group for the simsquid-service
     VpcId: !Ref VpcId

  SecurityGroupIngress:
   Type: AWS::EC2::SecurityGroupIngress
   Properties:
     GroupId: !Ref SecurityGroup
     IpProtocol: -1                     #すべてのプロトコルを許可
     CidrIp: !Ref InboundIpRange

  SecurityGroupEgress:
   Type: AWS::EC2::SecurityGroupEgress
   Properties:
     GroupId: !Ref SecurityGroup
     IpProtocol: -1                     #すべてのプロトコルを許可
     CidrIp: !Ref OutboundIpRange

 # -------------------------------------
 # Cloudwatchロググループ
 # -------------------------------------
  LogGroup:
   Type: AWS::Logs::LogGroup
   Properties:
     LogGroupName: !Sub /ecs/${ProjectName}

 # -------------------------------------
 # ロードバランサー
 # -------------------------------------
  LoadBalancer:
   Type: AWS::ElasticLoadBalancingV2::LoadBalancer
   Properties:
     Name: !Sub "${AWS::StackName}-nlb"
     Type: "network"
     Scheme: "internal"
     IpAddressType: ipv4
     Subnets:
       - !Ref ProtectedSubnets1
       - !Ref ProtectedSubnets2
     Tags:
       - Key: Name
         Value: !Sub "${AWS::StackName}.nlb"
  Listener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    DependsOn:
       - LoadBalancer
       - TargetGroup
    Properties:
      LoadBalancerArn: !Ref LoadBalancer
      Port: !Ref ListenerPort
      Protocol: TCP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref TargetGroup
  TargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    DependsOn: LoadBalancer
    Properties:
      Name: !Sub "${AWS::StackName}-tg"
      Port: !Ref ContainerPort
      Protocol: TCP
      VpcId: !Ref VpcId
      TargetType: !Ref TargetType
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}.targetgroup"
      TargetGroupAttributes:
        - Key: proxy_protocol_v2.enabled
          Value: true           #接続元アドレスを維持するためのもの（XFFみたいなやつ）
        - Key: stickiness.enabled
          Value: true           #接続元はセッションが終了するまで同じホスト（コンテナ）にアクセス。
        - Key: stickiness.type
          Value: "source_ip"

 # -------------------------------------
 # DNS（LBのDNSレコードをRoute53のAliasとして登録）
 # 事前にRoute53にHosted zoneが作成されていること。登録するときに末尾に.いれとく。
 # -------------------------------------
  LoadbalancerAlias:
   Type: AWS::Route53::RecordSetGroup
   Properties:
     HostedZoneName: !Ref Hostedzonename
     RecordSets:
       - Name: !Ref AliasName
         Type: A
         AliasTarget:
           HostedZoneId: !GetAtt "LoadBalancer.CanonicalHostedZoneID"
           DNSName: !GetAtt "LoadBalancer.DNSName"

 # -------------------------------------
 # ECSクラスター定義
 # -------------------------------------
  Cluster:
   Type: AWS::ECS::Cluster
   Properties:
     ClusterName: !Ref ProjectName

 # -------------------------------------
 # ECSサービス
 # -------------------------------------
  Service:
   Type: AWS::ECS::Service
   DependsOn:
     - Cluster
     - ECSTaskDefinition
     - SecurityGroup
     - SecurityGroupIngress
     - SecurityGroupEgress
     - LogGroup
     - TargetGroup
     - Listener
   Properties:
     Cluster: !Ref Cluster
     DeploymentConfiguration:
       MaximumPercent: 200
       MinimumHealthyPercent: 100
     DesiredCount: !Ref DesiredCount
     HealthCheckGracePeriodSeconds: !Ref HealthCheckGracePeriodSecond
     LoadBalancers:
       - ContainerName: !Ref AppName
         ContainerPort: !Ref ContainerPort
         TargetGroupArn: !Ref TargetGroup
     LaunchType: FARGATE
     PlatformVersion: '1.4.0'
     NetworkConfiguration:
       AwsvpcConfiguration:
         AssignPublicIp: DISABLED  #privateサブネットからNATGW越しにインターネットを利用する場合はDISABLED
         SecurityGroups:
           - !Ref SecurityGroup
         Subnets: 
           - !Ref ProtectedSubnets1
           - !Ref ProtectedSubnets2
     ServiceName: !Ref ProjectName
     TaskDefinition: !Ref ECSTaskDefinition

 # -------------------------------------
 # ECSタスク起動時に必要なロールを定義
 # -------------------------------------
  EcsTaskExecutionRole:
   Type: AWS::IAM::Role
   Properties:
     AssumeRolePolicyDocument:
       Version: 2012-10-17
       Statement:
         - Effect: Allow
           Principal:
             Service:
               - ecs-tasks.amazonaws.com
           Action:
             - sts:AssumeRole
     ManagedPolicyArns:
       - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
     Policies:
       - PolicyName: !Sub ${ProjectName}-EcsTaskExecutionRolePolicy
         PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - secretsmanager:GetSecretValue
                  - ecr:GetAuthorizationToken
                  - ecr:BatchCheckLayerAvailability
                  - ecr:GetDownloadUrlForLayer
                  - ecr:BatchGetImage
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource:
                  - "*"
     RoleName: !Sub ${ProjectName}-ecsTaskExecutionRole

 # -------------------------------------
 # ECSタスク（アプリそのもの）に必要なロールを定義
 # -------------------------------------
  EcsTaskRole:
   Type: AWS::IAM::Role
   Properties:
     AssumeRolePolicyDocument:
       Version: 2012-10-17
       Statement:
         - Effect: Allow
           Principal:
             Service:
               - ecs-tasks.amazonaws.com
               - events.amazonaws.com
           Action:
             - sts:AssumeRole
     ManagedPolicyArns:
       - arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceEventsRole
     RoleName: !Sub ${ProjectName}-task-role

  EcsTaskRolePolicy:
   Type: AWS::IAM::Policy
   Properties:
     PolicyName: !Sub ${ProjectName}-task-role-policy
     PolicyDocument:
       Version: 2012-10-17
       Statement:
         - Effect: Allow
           Action:
             - s3:List*
             - s3:Get*
             - s3:Put*
           Resource: '*'
     Roles:
       - Ref: EcsTaskRole

 # -------------------------------------
 # ECSタスク定義（Fargate）
 # -------------------------------------
  ECSTaskDefinition:
   Type: AWS::ECS::TaskDefinition
   Properties:
     Family: !Ref ProjectName
     RequiresCompatibilities:
       - FARGATE
     Cpu: !Ref TaskCpu
     Memory: !Ref TaskMemory
     NetworkMode: awsvpc
     ExecutionRoleArn: !Ref EcsTaskExecutionRole
     TaskRoleArn: !Ref EcsTaskRole
     Volumes:
       - Name: !Ref EFSFileSystemNameConf
         EFSVolumeConfiguration:
            authorizationConfig:
               accessPointId: !Ref EFSAccesspointConf 
            FilesystemId: !Ref EFSFileSystemId
            TransitEncryption: 'ENABLED'
       - Name: !Ref EFSFileSystemNameCache
         EFSVolumeConfiguration:
            authorizationConfig:
               accessPointId: !Ref EFSAccesspointCache
            FilesystemId: !Ref EFSFileSystemId
            TransitEncryption: 'ENABLED'
       - Name: !Ref EFSFileSystemNameLog
         EFSVolumeConfiguration:
            authorizationConfig:
               accessPointId: !Ref EFSAccesspointLog
            FilesystemId: !Ref EFSFileSystemId
            TransitEncryption: 'ENABLED'
     ContainerDefinitions:
       - Name: !Ref AppName
         Image: !Sub ${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${RepositoryName}
         PortMappings:
           - ContainerPort: !Ref ContainerPort
             HostPort: !Ref ContainerPort
             Protocol: tcp
         Environment:
           - Name: TZ
             Value: Asia/Tokyo
         LogConfiguration:
           LogDriver: awslogs
           Options:
             awslogs-region: !Ref 'AWS::Region'
             awslogs-group: !Ref LogGroup
             awslogs-create-group: true
             awslogs-stream-prefix: !Ref AppName
         Essential: true
         MountPoints:
          - SourceVolume: !Ref EFSFileSystemNameConf   # VolumesプロパティのNameと合わせる必要あり
            ContainerPath: /etc/squid
            ReadOnly: true  #定義ファイルなので読み取り専用でいい
          - SourceVolume: !Ref EFSFileSystemNameCache  # VolumesプロパティのNameと合わせる必要あり
            ContainerPath: /var/spool/squid
            ReadOnly: false
          - SourceVolume: !Ref EFSFileSystemNameLog    # VolumesプロパティのNameと合わせる必要あり
            ContainerPath: /var/log/squid
            ReadOnly: false 
